---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Photography - ${SITE_TITLE}`} description="Photography portfolio by Birol Senturk" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
	</head>
	<body>
		<Header />
		<main>
			<section class="gallery-section">
				<div class="container">
					<header class="page-header">
						<div class="header-content">
							<span class="section-label">Collection</span>
							<h1>Photography</h1>
						</div>
						<span class="photo-count" id="photo-count"></span>
					</header>

					<div class="gallery-loading" id="gallery-loading">
						<div class="loader"></div>
						<p>Loading photographs...</p>
					</div>

					<div class="gallery-empty" id="gallery-empty" style="display: none;">
						<p>New photographs coming soon.</p>
						<a href="/" class="btn btn--outline">Back to Home</a>
					</div>

					<div class="photo-grid" id="photo-grid"></div>
				</div>
			</section>
		</main>
		<Footer />

		<!-- Lightbox -->
		<div class="lightbox" id="lightbox" aria-hidden="true">
			<div class="lightbox-backdrop"></div>
			<button class="lightbox-close" aria-label="Close">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
				</svg>
			</button>
			<div class="lightbox-counter">
				<span id="current-index">1</span><span class="counter-divider">/</span><span id="total-count">0</span>
			</div>
			<button class="lightbox-nav lightbox-prev" aria-label="Previous">
				<svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2">
					<polyline points="20,6 10,16 20,26"/>
				</svg>
			</button>
			<button class="lightbox-nav lightbox-next" aria-label="Next">
				<svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2">
					<polyline points="12,6 22,16 12,26"/>
				</svg>
			</button>
			<div class="lightbox-stage">
				<figure class="lightbox-figure">
					<canvas id="lightbox-canvas"></canvas>
					<figcaption class="lightbox-caption">
						<h3 id="lightbox-title"></h3>
						<p id="lightbox-notes"></p>
					</figcaption>
				</figure>
			</div>
			<nav class="thumbnail-strip">
				<div class="thumbnail-track" id="thumbnail-track"></div>
			</nav>
		</div>
	</body>
</html>

<style>
	.gallery-section {
		padding: var(--space-md) 0 var(--space-xl);
		min-height: 60vh;
	}

	.page-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		padding-bottom: var(--space-sm);
		margin-bottom: var(--space-md);
		border-bottom: 1px solid var(--border);
		flex-wrap: wrap;
		gap: var(--space-sm);
	}

	.header-content {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}

	.page-header h1 {
		font-family: 'Cormorant Garamond', serif;
		font-size: clamp(2.5rem, 6vw, 4rem);
		font-weight: 300;
		letter-spacing: -0.02em;
		margin: 0;
		line-height: 1;
	}

	.photo-count {
		font-family: var(--font-display);
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--text-muted);
		letter-spacing: 0.02em;
	}

	.gallery-loading {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: var(--space-xl) 0;
		gap: var(--space-sm);
	}

	.loader {
		width: 32px;
		height: 32px;
		border: 2px solid var(--cream-dark);
		border-top-color: var(--accent);
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin { to { transform: rotate(360deg); } }

	.gallery-loading p {
		font-family: var(--font-display);
		font-size: 0.875rem;
		color: var(--text-muted);
	}

	.gallery-empty {
		text-align: center;
		padding: var(--space-xl) 0;
	}

	.gallery-empty p {
		color: var(--text-muted);
		margin-bottom: var(--space-md);
	}

	.photo-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 4px;
		opacity: 0;
		transition: opacity 0.4s ease;
	}

	.photo-grid.loaded { opacity: 1; }

	.photo-item {
		position: relative;
		overflow: hidden;
		cursor: pointer;
		background: var(--cream-dark);
	}

	.photo-item--wide { grid-column: span 2; }

	.photo-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		transition: transform 0.5s ease;
	}

	.photo-item:hover img { transform: scale(1.05); }

	.photo-image {
		position: relative;
		aspect-ratio: 4/3;
		overflow: hidden;
	}

	.photo-item--wide .photo-image { aspect-ratio: 16/9; }

	.photo-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
		opacity: 0;
		transition: opacity 0.3s ease;
		display: flex;
		align-items: flex-end;
		padding: var(--space-md);
	}

	.photo-item:hover .photo-overlay { opacity: 1; }

	.photo-info {
		color: white;
		transform: translateY(10px);
		transition: transform 0.3s ease;
	}

	.photo-item:hover .photo-info { transform: translateY(0); }

	.photo-info h3 {
		margin: 0;
		font-family: 'Cormorant Garamond', serif;
		font-size: 1.125rem;
		font-weight: 400;
		color: white;
	}

	.photo-item { animation: fadeIn 0.5s ease both; }
	@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

	/* Lightbox styles */
	.lightbox {
		position: fixed;
		inset: 0;
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		visibility: hidden;
		pointer-events: none;
	}

	.lightbox.active { visibility: visible; pointer-events: auto; }

	.lightbox-backdrop {
		position: absolute;
		inset: 0;
		background: #0a0a0a;
		opacity: 0;
		transition: opacity 0.4s ease;
	}

	.lightbox.active .lightbox-backdrop { opacity: 1; }

	.lightbox-close {
		position: absolute;
		top: 1.5rem;
		right: 1.5rem;
		z-index: 10;
		width: 48px;
		height: 48px;
		background: transparent;
		border: none;
		color: rgba(255,255,255,0.7);
		cursor: pointer;
		transition: all 0.2s;
		opacity: 0;
	}

	.lightbox.active .lightbox-close { opacity: 1; }
	.lightbox-close:hover { color: white; transform: scale(1.1); }

	.lightbox-counter {
		position: absolute;
		top: 1.75rem;
		left: 1.5rem;
		z-index: 10;
		font-family: var(--font-display);
		font-size: 0.875rem;
		color: rgba(255,255,255,0.5);
		opacity: 0;
	}

	.lightbox.active .lightbox-counter { opacity: 1; }
	.counter-divider { margin: 0 0.25rem; opacity: 0.5; }

	.lightbox-nav {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		z-index: 10;
		width: 64px;
		height: 64px;
		background: transparent;
		border: none;
		color: rgba(255,255,255,0.5);
		cursor: pointer;
		transition: all 0.2s;
		opacity: 0;
	}

	.lightbox.active .lightbox-nav { opacity: 1; }
	.lightbox-nav:hover { color: white; }
	.lightbox-prev { left: 1rem; }
	.lightbox-next { right: 1rem; }

	.lightbox-stage {
		position: relative;
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 5rem 6rem 7rem;
	}

	.lightbox-figure {
		position: relative;
		max-width: 100%;
		max-height: 100%;
		margin: 0;
		opacity: 0;
		transform: scale(0.95);
		transition: all 0.4s ease;
	}

	.lightbox.active .lightbox-figure { opacity: 1; transform: scale(1); }

	#lightbox-canvas {
		max-width: 100%;
		max-height: calc(100vh - 12rem);
		box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
	}

	.lightbox-caption {
		position: absolute;
		bottom: 0;
		left: 0;
		transform: translateY(calc(100% + 1rem));
		color: white;
	}

	.lightbox-caption h3 {
		font-family: 'Cormorant Garamond', serif;
		font-size: 1.25rem;
		font-weight: 400;
		margin: 0 0 0.25rem 0;
		color: rgba(255,255,255,0.9);
	}

	.lightbox-caption p {
		font-size: 0.875rem;
		color: rgba(255,255,255,0.5);
		margin: 0;
	}

	.thumbnail-strip {
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		height: 80px;
		background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
		padding: 1rem 6rem;
		opacity: 0;
		transition: all 0.3s ease;
	}

	.lightbox.active .thumbnail-strip { opacity: 1; }

	.thumbnail-track {
		display: flex;
		gap: 0.5rem;
		height: 100%;
		overflow-x: auto;
		scroll-behavior: smooth;
		scrollbar-width: none;
		padding: 0 calc(50% - 28px);
	}

	.thumbnail-track::-webkit-scrollbar { display: none; }

	.thumbnail-item {
		flex-shrink: 0;
		width: 56px;
		height: 56px;
		border-radius: 4px;
		overflow: hidden;
		cursor: pointer;
		opacity: 0.4;
		transition: all 0.2s;
		border: 2px solid transparent;
		background: #333;
	}

	.thumbnail-item:hover { opacity: 0.8; }
	.thumbnail-item.active { opacity: 1; border-color: var(--accent); }
	.thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }

	@media (max-width: 900px) {
		.photo-grid { grid-template-columns: repeat(2, 1fr); }
		.photo-item--wide { grid-column: span 2; }
		.lightbox-stage { padding: 4rem 3rem 6rem; }
		.thumbnail-strip { padding: 1rem 3rem; }
	}

	@media (max-width: 600px) {
		.page-header { flex-direction: column; align-items: flex-start; }
		.photo-grid { grid-template-columns: 1fr; gap: 2px; }
		.photo-item--wide { grid-column: span 1; }
		.photo-image, .photo-item--wide .photo-image { aspect-ratio: 4/3; }
		.photo-overlay { opacity: 1; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%); }
		.photo-info { transform: translateY(0); }
		.lightbox-stage { padding: 3rem 1rem 5rem; }
		.thumbnail-strip { padding: 0.75rem 1rem; height: 70px; }
		.thumbnail-item { width: 44px; height: 44px; }
	}
</style>

<script>
	interface GalleryItem {
		id: string;
		title: string;
		date: string;
		medium?: string;
		notes?: string;
		filename: string;
	}

	let items: GalleryItem[] = [];
	let currentIndex = 0;

	const grid = document.getElementById('photo-grid') as HTMLElement;
	const loading = document.getElementById('gallery-loading') as HTMLElement;
	const empty = document.getElementById('gallery-empty') as HTMLElement;
	const countEl = document.getElementById('photo-count') as HTMLElement;
	const lightbox = document.getElementById('lightbox') as HTMLElement;
	const lightboxCanvas = document.getElementById('lightbox-canvas') as HTMLCanvasElement;
	const lightboxTitle = document.getElementById('lightbox-title') as HTMLElement;
	const lightboxNotes = document.getElementById('lightbox-notes') as HTMLElement;
	const currentIndexEl = document.getElementById('current-index') as HTMLElement;
	const totalCountEl = document.getElementById('total-count') as HTMLElement;
	const thumbnailTrack = document.getElementById('thumbnail-track') as HTMLElement;

	async function renderImageToCanvasFit(canvas: HTMLCanvasElement, url: string): Promise<void> {
		return new Promise((resolve, reject) => {
			const img = new Image();
			img.crossOrigin = 'anonymous';
			img.onload = () => {
				const maxWidth = window.innerWidth - 160;
				const maxHeight = window.innerHeight - 200;
				let width = img.naturalWidth;
				let height = img.naturalHeight;
				const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
				width = Math.floor(width * ratio);
				height = Math.floor(height * ratio);
				canvas.width = width;
				canvas.height = height;
				const ctx = canvas.getContext('2d');
				if (ctx) ctx.drawImage(img, 0, 0, width, height);
				resolve();
			};
			img.onerror = reject;
			img.src = url;
		});
	}

	async function fetchItems() {
		try {
			const res = await fetch('/api/gallery?collection=photography');
			const data = await res.json();

			loading.style.display = 'none';

			if (data.error || !data.items?.length) {
				empty.style.display = 'block';
				return;
			}

			items = data.items;
			countEl.textContent = `${items.length} ${items.length === 1 ? 'photo' : 'photos'}`;
			totalCountEl.textContent = String(items.length);
			renderGrid();
			renderThumbnails();
		} catch (e) {
			loading.style.display = 'none';
			empty.style.display = 'block';
		}
	}

	async function renderGrid() {
		grid.innerHTML = '';

		for (let i = 0; i < items.length; i++) {
			const item = items[i];
			const article = document.createElement('article');
			article.className = `photo-item${i === 0 || i === 3 ? ' photo-item--wide' : ''}`;
			article.style.animationDelay = `${i * 0.05}s`;

			const imageDiv = document.createElement('div');
			imageDiv.className = 'photo-image';

			const img = document.createElement('img');
			img.src = `/api/gallery/${item.id}/thumbnail`;
			img.alt = item.title;
			img.loading = 'lazy';
			img.draggable = false;

			const overlay = document.createElement('div');
			overlay.className = 'photo-overlay';
			overlay.innerHTML = `<div class="photo-info"><h3>${item.title}</h3></div>`;

			imageDiv.appendChild(img);
			imageDiv.appendChild(overlay);
			article.appendChild(imageDiv);
			article.addEventListener('click', () => openLightbox(i));
			grid.appendChild(article);
		}

		requestAnimationFrame(() => grid.classList.add('loaded'));
	}

	async function renderThumbnails() {
		thumbnailTrack.innerHTML = '';
		for (let i = 0; i < items.length; i++) {
			const thumb = document.createElement('button');
			thumb.className = 'thumbnail-item';
			const img = document.createElement('img');
			img.src = `/api/gallery/${items[i].id}/thumbnail`;
			img.alt = items[i].title;
			img.draggable = false;
			thumb.appendChild(img);
			thumb.addEventListener('click', () => goToImage(i));
			thumbnailTrack.appendChild(thumb);
		}
	}

	async function openLightbox(index: number) {
		currentIndex = index;
		await updateLightboxImage();
		lightbox.classList.add('active');
		document.body.style.overflow = 'hidden';
	}

	function closeLightbox() {
		lightbox.classList.remove('active');
		document.body.style.overflow = '';
	}

	function goToImage(index: number) {
		if (index < 0) index = items.length - 1;
		if (index >= items.length) index = 0;
		currentIndex = index;
		updateLightboxImage();
	}

	async function updateLightboxImage() {
		const item = items[currentIndex];
		await renderImageToCanvasFit(lightboxCanvas, `/api/gallery/${item.id}/image`);
		lightboxTitle.textContent = item.title;
		lightboxNotes.textContent = item.notes || '';
		currentIndexEl.textContent = String(currentIndex + 1);

		document.querySelectorAll('.thumbnail-item').forEach((t, i) => t.classList.toggle('active', i === currentIndex));
		(thumbnailTrack.children[currentIndex] as HTMLElement)?.scrollIntoView({ behavior: 'smooth', inline: 'center' });
	}

	document.querySelector('.lightbox-close')?.addEventListener('click', closeLightbox);
	document.querySelector('.lightbox-backdrop')?.addEventListener('click', closeLightbox);
	document.querySelector('.lightbox-prev')?.addEventListener('click', () => goToImage(currentIndex - 1));
	document.querySelector('.lightbox-next')?.addEventListener('click', () => goToImage(currentIndex + 1));

	document.addEventListener('keydown', (e) => {
		if (!lightbox.classList.contains('active')) return;
		if (e.key === 'Escape') closeLightbox();
		if (e.key === 'ArrowLeft') goToImage(currentIndex - 1);
		if (e.key === 'ArrowRight') goToImage(currentIndex + 1);
	});

	grid.addEventListener('contextmenu', (e) => e.preventDefault());
	lightbox.addEventListener('contextmenu', (e) => e.preventDefault());

	fetchItems();
</script>
