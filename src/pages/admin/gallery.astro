---
import BaseHead from '../../components/BaseHead.astro';
import { SITE_TITLE } from '../../consts';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Admin - ${SITE_TITLE}`} description="Gallery administration" />
		<meta name="robots" content="noindex, nofollow" />
	</head>
	<body>
		<!-- Login Screen -->
		<div class="login-screen" id="login-screen">
			<div class="login-card">
				<div class="login-header">
					<svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="1.5">
						<rect x="4" y="8" width="24" height="20" rx="2"/>
						<circle cx="16" cy="18" r="3"/>
						<path d="M10 8V6a6 6 0 0 1 12 0v2"/>
					</svg>
					<h1>Gallery Admin</h1>
				</div>
				<form id="login-form">
					<input type="password" id="password" placeholder="Enter password" autocomplete="current-password" required />
					<button type="submit" class="btn-primary">Sign In</button>
				</form>
				<p class="login-error" id="login-error"></p>
			</div>
		</div>

		<!-- Admin Dashboard -->
		<div class="admin-dashboard" id="admin-dashboard" style="display: none;">
			<header class="admin-header">
				<div class="admin-header-left">
					<a href="/" class="back-link">
						<svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
							<path d="M15 10H5M5 10L10 5M5 10L10 15"/>
						</svg>
						Back to site
					</a>
					<h1>Gallery Admin</h1>
				</div>
				<button class="btn-outline" id="logout-btn">Sign Out</button>
			</header>

			<main class="admin-main">
				<!-- Upload Section -->
				<section class="upload-section">
					<h2>Upload New Artwork</h2>
					<form id="upload-form" class="upload-form">
						<div class="dropzone" id="dropzone">
							<input type="file" id="file-input" accept="image/*" hidden />
							<div class="dropzone-content">
								<svg width="48" height="48" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
									<path d="M8 32l8-8 6 6 12-12 6 6"/>
									<rect x="4" y="8" width="40" height="32" rx="4"/>
									<circle cx="14" cy="18" r="4"/>
								</svg>
								<p>Drag & drop an image here or <span class="dropzone-browse">browse</span></p>
								<span class="dropzone-hint">JPG, PNG, WebP up to 10MB</span>
							</div>
							<div class="dropzone-preview" id="dropzone-preview" style="display: none;">
								<img id="preview-image" src="" alt="Preview" />
								<button type="button" class="preview-remove" id="preview-remove">
									<svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="15" y1="5" x2="5" y2="15"/>
										<line x1="5" y1="5" x2="15" y2="15"/>
									</svg>
								</button>
							</div>
						</div>

						<div class="form-grid">
							<div class="form-group">
								<label for="title">Title</label>
								<input type="text" id="title" name="title" placeholder="Artwork title" />
							</div>

							<div class="form-group">
								<label for="date">Date</label>
								<input type="date" id="date" name="date" />
							</div>

							<div class="form-group">
								<label for="collection">Collection</label>
								<select id="collection" name="collection">
									<option value="art">Art</option>
									<option value="photography">Photography</option>
								</select>
							</div>

							<div class="form-group">
								<label for="medium">Medium</label>
								<input type="text" id="medium" name="medium" placeholder="e.g., Oil on canvas, Digital" />
							</div>

							<div class="form-group form-group--full">
								<label for="notes">Notes</label>
								<textarea id="notes" name="notes" rows="3" placeholder="Additional notes about this piece..."></textarea>
							</div>
						</div>

						<div class="form-actions">
							<button type="submit" class="btn-primary" id="upload-btn" disabled>
								<span class="btn-text">Upload Artwork</span>
								<span class="btn-loading" style="display: none;">
									<svg class="spinner" width="20" height="20" viewBox="0 0 20 20">
										<circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="40" stroke-dashoffset="10"/>
									</svg>
									Uploading...
								</span>
							</button>
						</div>
					</form>
				</section>

				<!-- Gallery Items -->
				<section class="items-section">
					<div class="items-header">
						<h2>Gallery Items</h2>
						<div class="items-filter">
							<button class="filter-btn active" data-filter="all">All</button>
							<button class="filter-btn" data-filter="art">Art</button>
							<button class="filter-btn" data-filter="photography">Photography</button>
						</div>
					</div>

					<div class="items-grid" id="items-grid">
						<div class="items-loading">Loading...</div>
					</div>
				</section>
			</main>
		</div>

		<!-- Edit Modal -->
		<div class="modal" id="edit-modal" style="display: none;">
			<div class="modal-backdrop"></div>
			<div class="modal-content">
				<div class="modal-header">
					<h3>Edit Artwork</h3>
					<button class="modal-close" id="modal-close">
						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"/>
							<line x1="6" y1="6" x2="18" y2="18"/>
						</svg>
					</button>
				</div>
				<form id="edit-form">
					<input type="hidden" id="edit-id" />

					<div class="modal-preview">
						<img id="edit-preview" src="" alt="" />
					</div>

					<div class="form-group">
						<label for="edit-title">Title</label>
						<input type="text" id="edit-title" />
					</div>

					<div class="form-row">
						<div class="form-group">
							<label for="edit-date">Date</label>
							<input type="date" id="edit-date" />
						</div>
						<div class="form-group">
							<label for="edit-collection">Collection</label>
							<select id="edit-collection">
								<option value="art">Art</option>
								<option value="photography">Photography</option>
							</select>
						</div>
					</div>

					<div class="form-group">
						<label for="edit-medium">Medium</label>
						<input type="text" id="edit-medium" />
					</div>

					<div class="form-group">
						<label for="edit-notes">Notes</label>
						<textarea id="edit-notes" rows="3"></textarea>
					</div>

					<div class="modal-actions">
						<button type="button" class="btn-danger" id="delete-btn">Delete</button>
						<button type="submit" class="btn-primary">Save Changes</button>
					</div>
				</form>
			</div>
		</div>
	</body>
</html>

<style>
	* {
		box-sizing: border-box;
	}

	body {
		font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
		margin: 0;
		padding: 0;
		background: #FAF7F2;
		color: #1A1A1A;
		min-height: 100vh;
	}

	/* Login Screen */
	.login-screen {
		min-height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem;
	}

	.login-card {
		background: white;
		padding: 3rem;
		border-radius: 12px;
		box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
		width: 100%;
		max-width: 380px;
	}

	.login-header {
		text-align: center;
		margin-bottom: 2rem;
		color: #1A1A1A;
	}

	.login-header svg {
		margin-bottom: 1rem;
		color: #D95D39;
	}

	.login-header h1 {
		font-family: 'Syne', sans-serif;
		font-size: 1.5rem;
		font-weight: 700;
		margin: 0;
	}

	#login-form {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	#login-form input {
		padding: 1rem;
		border: 2px solid #E5E5E5;
		border-radius: 8px;
		font-size: 1rem;
		transition: border-color 0.2s;
	}

	#login-form input:focus {
		outline: none;
		border-color: #D95D39;
	}

	.btn-primary {
		background: #D95D39;
		color: white;
		border: none;
		padding: 1rem 1.5rem;
		border-radius: 8px;
		font-family: 'Syne', sans-serif;
		font-size: 0.875rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		cursor: pointer;
		transition: all 0.2s;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
	}

	.btn-primary:hover:not(:disabled) {
		background: #C44D2B;
		transform: translateY(-1px);
	}

	.btn-primary:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.btn-outline {
		background: transparent;
		color: #1A1A1A;
		border: 2px solid #E5E5E5;
		padding: 0.75rem 1.25rem;
		border-radius: 8px;
		font-family: 'Syne', sans-serif;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-outline:hover {
		border-color: #1A1A1A;
		background: #1A1A1A;
		color: white;
	}

	.btn-danger {
		background: transparent;
		color: #DC2626;
		border: 2px solid #DC2626;
		padding: 0.75rem 1.25rem;
		border-radius: 8px;
		font-family: 'Syne', sans-serif;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-danger:hover {
		background: #DC2626;
		color: white;
	}

	.login-error {
		color: #DC2626;
		font-size: 0.875rem;
		text-align: center;
		margin: 0;
		min-height: 1.25rem;
	}

	/* Admin Dashboard */
	.admin-header {
		background: white;
		padding: 1rem 2rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		border-bottom: 1px solid #E5E5E5;
		position: sticky;
		top: 0;
		z-index: 100;
	}

	.admin-header-left {
		display: flex;
		align-items: center;
		gap: 1.5rem;
	}

	.back-link {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		color: #6B6B6B;
		text-decoration: none;
		font-size: 0.875rem;
		transition: color 0.2s;
	}

	.back-link:hover {
		color: #D95D39;
	}

	.admin-header h1 {
		font-family: 'Syne', sans-serif;
		font-size: 1.25rem;
		font-weight: 700;
		margin: 0;
	}

	.admin-main {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}

	/* Upload Section */
	.upload-section {
		background: white;
		border-radius: 12px;
		padding: 2rem;
		margin-bottom: 2rem;
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
	}

	.upload-section h2 {
		font-family: 'Syne', sans-serif;
		font-size: 1.125rem;
		font-weight: 600;
		margin: 0 0 1.5rem 0;
	}

	.dropzone {
		border: 2px dashed #D4D4D4;
		border-radius: 12px;
		padding: 3rem 2rem;
		text-align: center;
		cursor: pointer;
		transition: all 0.2s;
		margin-bottom: 1.5rem;
		position: relative;
		overflow: hidden;
	}

	.dropzone:hover,
	.dropzone.dragover {
		border-color: #D95D39;
		background: rgba(217, 93, 57, 0.04);
	}

	.dropzone-content svg {
		color: #A3A3A3;
		margin-bottom: 1rem;
	}

	.dropzone-content p {
		margin: 0 0 0.5rem 0;
		color: #3D3D3D;
	}

	.dropzone-browse {
		color: #D95D39;
		font-weight: 600;
	}

	.dropzone-hint {
		font-size: 0.875rem;
		color: #6B6B6B;
	}

	.dropzone-preview {
		position: absolute;
		inset: 0;
		background: #F5F5F5;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.dropzone-preview img {
		max-width: 100%;
		max-height: 200px;
		object-fit: contain;
	}

	.preview-remove {
		position: absolute;
		top: 1rem;
		right: 1rem;
		background: white;
		border: none;
		width: 36px;
		height: 36px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		transition: all 0.2s;
	}

	.preview-remove:hover {
		background: #DC2626;
		color: white;
	}

	.form-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1rem;
	}

	.form-group {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.form-group--full {
		grid-column: 1 / -1;
	}

	.form-group label {
		font-family: 'Syne', sans-serif;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: #6B6B6B;
	}

	.form-group input,
	.form-group select,
	.form-group textarea {
		padding: 0.875rem 1rem;
		border: 2px solid #E5E5E5;
		border-radius: 8px;
		font-size: 0.9375rem;
		font-family: inherit;
		transition: border-color 0.2s;
		background: white;
	}

	.form-group input:focus,
	.form-group select:focus,
	.form-group textarea:focus {
		outline: none;
		border-color: #D95D39;
	}

	.form-group textarea {
		resize: vertical;
	}

	.form-actions {
		margin-top: 1.5rem;
		display: flex;
		justify-content: flex-end;
	}

	.spinner {
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		from { transform: rotate(0deg); }
		to { transform: rotate(360deg); }
	}

	/* Items Section */
	.items-section {
		background: white;
		border-radius: 12px;
		padding: 2rem;
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
	}

	.items-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5rem;
	}

	.items-header h2 {
		font-family: 'Syne', sans-serif;
		font-size: 1.125rem;
		font-weight: 600;
		margin: 0;
	}

	.items-filter {
		display: flex;
		gap: 0.25rem;
		background: #F5F5F5;
		padding: 0.25rem;
		border-radius: 8px;
	}

	.filter-btn {
		background: transparent;
		border: none;
		padding: 0.5rem 1rem;
		font-family: 'Syne', sans-serif;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.03em;
		color: #6B6B6B;
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s;
	}

	.filter-btn:hover {
		color: #1A1A1A;
	}

	.filter-btn.active {
		background: white;
		color: #1A1A1A;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
	}

	.items-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 1rem;
	}

	.items-loading {
		grid-column: 1 / -1;
		text-align: center;
		padding: 3rem;
		color: #6B6B6B;
	}

	.item-card {
		position: relative;
		border-radius: 8px;
		overflow: hidden;
		background: #F5F5F5;
		aspect-ratio: 1;
		cursor: pointer;
		transition: all 0.2s;
	}

	.item-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
	}

	.item-card img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.item-card-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 50%);
		opacity: 0;
		transition: opacity 0.2s;
		display: flex;
		flex-direction: column;
		justify-content: flex-end;
		padding: 1rem;
	}

	.item-card:hover .item-card-overlay {
		opacity: 1;
	}

	.item-card-title {
		color: white;
		font-weight: 600;
		font-size: 0.875rem;
		margin: 0 0 0.25rem 0;
	}

	.item-card-meta {
		color: rgba(255, 255, 255, 0.7);
		font-size: 0.75rem;
	}

	.item-card-badge {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		background: white;
		padding: 0.25rem 0.5rem;
		border-radius: 4px;
		font-family: 'Syne', sans-serif;
		font-size: 0.625rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: #6B6B6B;
	}

	/* Modal */
	.modal {
		position: fixed;
		inset: 0;
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem;
	}

	.modal-backdrop {
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.6);
	}

	.modal-content {
		position: relative;
		background: white;
		border-radius: 12px;
		width: 100%;
		max-width: 500px;
		max-height: 90vh;
		overflow-y: auto;
		padding: 2rem;
	}

	.modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5rem;
	}

	.modal-header h3 {
		font-family: 'Syne', sans-serif;
		font-size: 1.125rem;
		font-weight: 600;
		margin: 0;
	}

	.modal-close {
		background: transparent;
		border: none;
		color: #6B6B6B;
		cursor: pointer;
		padding: 0.5rem;
		transition: color 0.2s;
	}

	.modal-close:hover {
		color: #1A1A1A;
	}

	.modal-preview {
		background: #F5F5F5;
		border-radius: 8px;
		overflow: hidden;
		margin-bottom: 1.5rem;
		aspect-ratio: 16/10;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.modal-preview img {
		max-width: 100%;
		max-height: 100%;
		object-fit: contain;
	}

	.form-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
	}

	.modal-actions {
		display: flex;
		justify-content: space-between;
		margin-top: 1.5rem;
		padding-top: 1.5rem;
		border-top: 1px solid #E5E5E5;
	}

	/* Responsive */
	@media (max-width: 768px) {
		.admin-header {
			padding: 1rem;
		}

		.admin-main {
			padding: 1rem;
		}

		.form-grid {
			grid-template-columns: 1fr;
		}

		.items-header {
			flex-direction: column;
			align-items: flex-start;
			gap: 1rem;
		}

		.form-row {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	let authToken: string | null = null;
	let currentFilter = 'all';

	const loginScreen = document.getElementById('login-screen') as HTMLElement;
	const adminDashboard = document.getElementById('admin-dashboard') as HTMLElement;
	const loginForm = document.getElementById('login-form') as HTMLFormElement;
	const loginError = document.getElementById('login-error') as HTMLElement;
	const logoutBtn = document.getElementById('logout-btn') as HTMLButtonElement;

	const dropzone = document.getElementById('dropzone') as HTMLElement;
	const fileInput = document.getElementById('file-input') as HTMLInputElement;
	const dropzoneContent = dropzone.querySelector('.dropzone-content') as HTMLElement;
	const dropzonePreview = document.getElementById('dropzone-preview') as HTMLElement;
	const previewImage = document.getElementById('preview-image') as HTMLImageElement;
	const previewRemove = document.getElementById('preview-remove') as HTMLButtonElement;
	const uploadForm = document.getElementById('upload-form') as HTMLFormElement;
	const uploadBtn = document.getElementById('upload-btn') as HTMLButtonElement;

	const itemsGrid = document.getElementById('items-grid') as HTMLElement;
	const filterBtns = document.querySelectorAll('.filter-btn');

	const editModal = document.getElementById('edit-modal') as HTMLElement;
	const editForm = document.getElementById('edit-form') as HTMLFormElement;
	const modalClose = document.getElementById('modal-close') as HTMLButtonElement;
	const deleteBtn = document.getElementById('delete-btn') as HTMLButtonElement;

	let selectedFile: File | null = null;

	// Check for stored token
	const storedToken = sessionStorage.getItem('gallery_admin_token');
	if (storedToken) {
		authToken = storedToken;
		showDashboard();
	}

	// Login
	loginForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const password = (document.getElementById('password') as HTMLInputElement).value;

		try {
			const res = await fetch('/api/admin/auth', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ password })
			});

			const data = await res.json();

			if (data.success) {
				authToken = data.token;
				sessionStorage.setItem('gallery_admin_token', data.token);
				showDashboard();
			} else {
				loginError.textContent = data.error || 'Invalid password';
			}
		} catch (error) {
			loginError.textContent = 'Login failed. Please try again.';
		}
	});

	// Logout
	logoutBtn.addEventListener('click', () => {
		authToken = null;
		sessionStorage.removeItem('gallery_admin_token');
		loginScreen.style.display = 'flex';
		adminDashboard.style.display = 'none';
	});

	function showDashboard() {
		loginScreen.style.display = 'none';
		adminDashboard.style.display = 'block';
		loadItems();
	}

	// Dropzone
	dropzone.addEventListener('click', () => fileInput.click());
	dropzone.addEventListener('dragover', (e) => {
		e.preventDefault();
		dropzone.classList.add('dragover');
	});
	dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
	dropzone.addEventListener('drop', (e) => {
		e.preventDefault();
		dropzone.classList.remove('dragover');
		const files = e.dataTransfer?.files;
		if (files && files[0]) handleFile(files[0]);
	});

	fileInput.addEventListener('change', () => {
		if (fileInput.files && fileInput.files[0]) {
			handleFile(fileInput.files[0]);
		}
	});

	previewRemove.addEventListener('click', (e) => {
		e.stopPropagation();
		clearFile();
	});

	function handleFile(file: File) {
		if (!file.type.startsWith('image/')) {
			alert('Please select an image file');
			return;
		}

		selectedFile = file;
		const url = URL.createObjectURL(file);
		previewImage.src = url;
		dropzoneContent.style.display = 'none';
		dropzonePreview.style.display = 'flex';
		uploadBtn.disabled = false;
	}

	function clearFile() {
		selectedFile = null;
		fileInput.value = '';
		previewImage.src = '';
		dropzoneContent.style.display = 'block';
		dropzonePreview.style.display = 'none';
		uploadBtn.disabled = true;
	}

	// Resize image before upload (max 2000px on longest side)
	async function resizeImage(file: File, maxSize: number = 2000): Promise<File> {
		return new Promise((resolve) => {
			const img = new Image();
			img.onload = () => {
				let { width, height } = img;

				// Only resize if larger than maxSize
				if (width <= maxSize && height <= maxSize) {
					resolve(file);
					return;
				}

				// Calculate new dimensions
				if (width > height) {
					height = Math.round((height / width) * maxSize);
					width = maxSize;
				} else {
					width = Math.round((width / height) * maxSize);
					height = maxSize;
				}

				// Draw to canvas
				const canvas = document.createElement('canvas');
				canvas.width = width;
				canvas.height = height;
				const ctx = canvas.getContext('2d')!;
				ctx.drawImage(img, 0, 0, width, height);

				// Convert to blob
				canvas.toBlob((blob) => {
					if (blob) {
						const resizedFile = new File([blob], file.name, { type: 'image/jpeg' });
						resolve(resizedFile);
					} else {
						resolve(file);
					}
				}, 'image/jpeg', 0.9);
			};
			img.src = URL.createObjectURL(file);
		});
	}

	// Upload
	uploadForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		if (!selectedFile || !authToken) return;

		const btnText = uploadBtn.querySelector('.btn-text') as HTMLElement;
		const btnLoading = uploadBtn.querySelector('.btn-loading') as HTMLElement;
		btnText.style.display = 'none';
		btnLoading.style.display = 'flex';
		uploadBtn.disabled = true;

		// Resize image before upload
		const resizedFile = await resizeImage(selectedFile);

		const formData = new FormData();
		formData.append('file', resizedFile);
		formData.append('title', (document.getElementById('title') as HTMLInputElement).value);
		formData.append('date', (document.getElementById('date') as HTMLInputElement).value);
		formData.append('collection', (document.getElementById('collection') as HTMLSelectElement).value);
		formData.append('medium', (document.getElementById('medium') as HTMLInputElement).value);
		formData.append('notes', (document.getElementById('notes') as HTMLTextAreaElement).value);

		try {
			const res = await fetch('/api/admin/upload', {
				method: 'POST',
				headers: { 'Authorization': `Bearer ${authToken}` },
				body: formData
			});

			const data = await res.json();

			if (data.success) {
				clearFile();
				uploadForm.reset();
				loadItems();
			} else {
				alert(data.error || 'Upload failed');
			}
		} catch (error) {
			alert('Upload failed. Please try again.');
		} finally {
			btnText.style.display = 'inline';
			btnLoading.style.display = 'none';
		}
	});

	// Load items
	async function loadItems() {
		itemsGrid.innerHTML = '<div class="items-loading">Loading...</div>';

		try {
			const url = currentFilter === 'all'
				? '/api/gallery'
				: `/api/gallery?collection=${currentFilter}`;

			const res = await fetch(url);
			const data = await res.json();

			if (data.items && data.items.length > 0) {
				itemsGrid.innerHTML = data.items.map((item: any) => `
					<article class="item-card" data-id="${item.id}">
						<img src="/api/gallery/${item.id}/image" alt="${item.title}" loading="lazy" />
						<div class="item-card-overlay">
							<h4 class="item-card-title">${item.title}</h4>
							<span class="item-card-meta">${item.date || 'No date'}</span>
						</div>
						<span class="item-card-badge">${item.collection || 'art'}</span>
					</article>
				`).join('');

				// Add click handlers
				document.querySelectorAll('.item-card').forEach(card => {
					card.addEventListener('click', () => openEditModal(card.getAttribute('data-id')!));
				});
			} else {
				itemsGrid.innerHTML = '<div class="items-loading">No items yet. Upload your first artwork!</div>';
			}
		} catch (error) {
			itemsGrid.innerHTML = '<div class="items-loading">Failed to load items</div>';
		}
	}

	// Filter
	filterBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			filterBtns.forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			currentFilter = (btn as HTMLElement).dataset.filter || 'all';
			loadItems();
		});
	});

	// Edit Modal
	async function openEditModal(id: string) {
		if (!authToken) return;

		try {
			const res = await fetch(`/api/admin/item/${id}`, {
				headers: { 'Authorization': `Bearer ${authToken}` }
			});
			const item = await res.json();

			(document.getElementById('edit-id') as HTMLInputElement).value = id;
			(document.getElementById('edit-preview') as HTMLImageElement).src = `/api/gallery/${id}/image`;
			(document.getElementById('edit-title') as HTMLInputElement).value = item.title || '';
			(document.getElementById('edit-date') as HTMLInputElement).value = item.date || '';
			(document.getElementById('edit-collection') as HTMLSelectElement).value = item.collection || 'art';
			(document.getElementById('edit-medium') as HTMLInputElement).value = item.medium || '';
			(document.getElementById('edit-notes') as HTMLTextAreaElement).value = item.notes || '';

			editModal.style.display = 'flex';
		} catch (error) {
			alert('Failed to load item');
		}
	}

	function closeEditModal() {
		editModal.style.display = 'none';
	}

	modalClose.addEventListener('click', closeEditModal);
	editModal.querySelector('.modal-backdrop')?.addEventListener('click', closeEditModal);

	// Save changes
	editForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const id = (document.getElementById('edit-id') as HTMLInputElement).value;

		try {
			const res = await fetch(`/api/admin/item/${id}`, {
				method: 'PUT',
				headers: {
					'Authorization': `Bearer ${authToken}`,
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					title: (document.getElementById('edit-title') as HTMLInputElement).value,
					date: (document.getElementById('edit-date') as HTMLInputElement).value,
					collection: (document.getElementById('edit-collection') as HTMLSelectElement).value,
					medium: (document.getElementById('edit-medium') as HTMLInputElement).value,
					notes: (document.getElementById('edit-notes') as HTMLTextAreaElement).value
				})
			});

			const data = await res.json();

			if (data.success) {
				closeEditModal();
				loadItems();
			} else {
				alert(data.error || 'Save failed');
			}
		} catch (error) {
			alert('Save failed. Please try again.');
		}
	});

	// Delete
	deleteBtn.addEventListener('click', async () => {
		const id = (document.getElementById('edit-id') as HTMLInputElement).value;

		if (!confirm('Are you sure you want to delete this artwork? This cannot be undone.')) {
			return;
		}

		try {
			const res = await fetch(`/api/admin/item/${id}`, {
				method: 'DELETE',
				headers: { 'Authorization': `Bearer ${authToken}` }
			});

			const data = await res.json();

			if (data.success) {
				closeEditModal();
				loadItems();
			} else {
				alert(data.error || 'Delete failed');
			}
		} catch (error) {
			alert('Delete failed. Please try again.');
		}
	});

	// Keyboard shortcuts
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && editModal.style.display === 'flex') {
			closeEditModal();
		}
	});
</script>
